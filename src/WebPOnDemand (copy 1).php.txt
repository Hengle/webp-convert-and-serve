<?php
/*
URL parameters:

source: Path to source file.
    Can be absolute or relative (relative to document root).
    If it starts with "/", it is considered an absolute path.

destination-root (optional):
    The final destination will be calculated like this:
        [desired destination root] + [relative path of source file] + ".webp".

    - Both absolute paths and relative paths are accepted (if the path starts with "/", it is considered an absolute
      path).
    - Double-dots in paths are allowed, ie "../webp-cache"

    If you want converted files to be put in the same folder as the originals, you can set destination-root to ".", or
    leave it blank. If you on the other hand want all converted files to reside in their own folder, set the
    destination-root to point to that folder. The converted files will be stored in a hierarchy that matches the source
    files. With destination-root set to "webp-cache", the source file "images/2017/cool.jpg" will be stored at
    "webp-cache/images/2017/cool.jpg.webp".

quality (optional):
    Default value: 85
    The quality of the generated WebP image, 0-100.

strip-metadata:
    If set (if "&strip-metadata" is appended to the url), metadata will not be copied over in the conversion process.
    Note however that not all converters supports copying metadata. cwebp supports it, imagewebp does not. You can
    also assign a value.
    Any value but "no" counts as yes

preferred-converters (optional):
    Setting this manipulates the default order in which the converters are tried. If you for example set it to "cwebp",
    it means that you want "cwebp" to be tried first. You can specify several favourite converters. Setting it to
    "cwebp,imagewebp" will put cwebp to the top of the list and imagewebp will be the next converter to try, if cwebp
    fails.
    The option will not remove any converters from the list, only change the order.

serve-image (optional):
    If set (if "&serve-image" is appended to the URL), the converted image will be served. Otherwise the script will
    produce text output about the convertion process. You can also assign a value. Any value but "no" counts as yes.

destination (optional): (TODO)
    Path to destination file. Can be absolute or relative (relative to document root).
    You can choose not to specify destination. In that case, the path will be created based upon source,
    destination-root and root-folder settings. If all these are blank, the destination will be same folder as source,
    and the filename will have ".webp" appended to it (ie image.jpeg.webp)

root-folder (optional):
    Usually, you will not need to supply anything. Might be relevant in rare occasions where the converter that
    generates the URL cannot pass all of the relative path. For example, an .htaccess located in a subfolder may have
    trouble passing the parent folders.

debug (optional):
    Enabling debug has two functions:
    1) It will always return text (serve-image setting is overriden)
    2) PHP error reporting is turned on

serve-original-image-on-fail (optional):
    Default: "yes".
    Decides what action to take in the situation that
        (1) all converters fails to convert the image, and
        (2) WebPConvert is told to serve the converted image.
    Default action is to serve the *original* image. End-users will not notice the fail, which is good on production
    servers, but not on development servers.
    If set to "no", WebPConvert will instead generate an image containing the error message.

ewww-key (optional):
    Key to EWWW Image Converter


Example:
http://playground/webp-on-demand-test/webp-on-demand/webp-convert.php?source=/var/www/test/images/subfolder/logo.jpg&preferred-converters=ewww&destination-root=cold&serve-image=no&serve-original-image-on-fail=no&debug=no
*/

namespace WebPOnDemand;

use WebPConvert\WebPConvert;
use WebPOnDemand\PathHelper;

class WebPOnDemand
{
    public static function convertAndServeImage($source, $destination, $webpOptions, $serveOriginalImageOnFail, $debug)
    {
        if ($debug) {
            error_reporting(E_ALL);
            ini_set('display_errors', 'On');
        } else {
            ini_set('display_errors', 'Off');
        }


    }

    public static function serve()
    {
        $serveConvertedImage = (isset($_GET['serve-image']) ? ($_GET['serve-image'] != 'no') : false);
        $debug = (isset($_GET['debug']) ? ($_GET['debug'] != 'no') : false);
        if ($debug) {
            $serveConvertedImage = false;
            error_reporting(E_ALL);
            ini_set('display_errors', 'On');
        } else {
            if ($serveConvertedImage) {
                ini_set('display_errors', 'Off');
            }
        }


        $root = (
            isset($_GET['root-folder']) ?
                PathHelper::removeDoubleSlash($_SERVER['DOCUMENT_ROOT'] . '/' . $_GET['root-folder']) :
                null
        );

        //echo __DIR__ . '/' . $_GET['source'];

        //exit;
        //$source = PathHelper::abspath($_GET['source'], $root);
        //$destination = PathHelper::getDestinationPath($source, isset($_GET['destination-root']) ? $_GET['destination-root'] : '.', $root);

        $source = __DIR__ . '/' . $_GET['source'];
        $destination = $source . '.webp';

        if (isset($_GET['destination-root'])) {
            echo $_GET['destination-root'];
        //    exit;
        }

        $quality = (isset($_GET['quality']) ? intval($_GET['quality']) : 85);
        $strip_metadata = (isset($_GET['strip-metadata']) ? ($_GET['strip-metadata'] != 'no') : false);

        //$preferred_converters = array('imagewebp', 'cwebp');

        if (isset($_GET['ewww-key'])) {
        //  WebPConvertEWW::setKey($_GET['ewww-key']);
        //  WebPConvert::
        //  define("WEBPCONVERT_EWW_KEY", $_GET['ewww-key']);
        }


        //$serveConvertedImage;
        $serveOriginalImageOnFail = (isset($_GET['serve-original-image-on-fail']) ? ($_GET['serve-original-image-on-fail'] != 'no') : true);

        $options = array(
            'quality' => (isset($_GET['quality']) ? intval($_GET['quality']) : 85),
            'metadata' => ($strip_metadata ? 'none' : 'all')
        );

        if (isset($_GET['preferred-converters'])) {
            $options['converters'] = explode(',', $_GET['preferred-converters']);
        }

        //WebPConvert::set_preferred_converters($preferred_converters);
        if ($debug) {
            echo '<i>source:</i> ' . $source . '<br>';
            echo '<i>destination:</i> ' . $destination . '<br>';
            echo '<i>options:</i> ' . print_r($options, true) . '<br>';
            echo '<br>';
        }
        try {
            $success = WebPConvert::convert($source, $destination, $options);
        } catch (\Exception $e) {
            $success = false;

            $msg = $e->getMessage();

            if ($debug) {
                //throw $e;
                echo $msg;
                exit;
            }
        }

        if ($success) {
            if ($serveConvertedImage) {
                header('Content-type: image/webp');
                // Should we add Content-Length header?
                // header('Content-Length: ' . filesize($file));
                readfile($destination);
            } else {
                if ($debug) {
                    echo 'ok';
                }
            }
        } else {
            if ($serveConvertedImage) {
                if ($serveOriginalImageOnFail && file_exists($source)) {
                    // Prevent caching image
                    header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
                    header("Cache-Control: post-check=0, pre-check=0", false);
                    header("Pragma: no-cache");

                    $ext = array_pop(explode('.', $source));
                    switch (strtolower($ext)) {
                        case 'jpg':
                        case 'jpeg':
                            header('Content-type: image/jpeg');
                            break;
                        case 'png':
                            header('Content-type: image/png');
                            break;
                    }
                    readfile($source);
                } else {
                    // TODO: Perhaps it would be better to return a 404 ?

                    // Generate image containing error message
                    header('Content-type: image/gif');

                    // Prevent caching image
                    header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
                    header("Cache-Control: post-check=0, pre-check=0", false);
                    header("Pragma: no-cache");

                    $image = imagecreatetruecolor(620, 200);
                    imagestring($image, 1, 5, 5, $msg, imagecolorallocate($image, 233, 214, 291));
                    // echo imagewebp($image);
                    echo imagegif($image);
                    imagedestroy($image);
                }
            } else {
                echo 'Conversion failed. None of the tried converters are operational';
            }
        }
    }
}
